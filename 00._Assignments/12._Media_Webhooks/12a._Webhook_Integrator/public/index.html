<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Integrator Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        button {
            background-color: #4a90e2;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3a80d2;
        }
        button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        #responseContainer {
            background-color: #f5f7fa;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #2ecc71;
        }
        .error {
            color: #e74c3c;
        }
        #webhooksTable {
            width: 100%;
            border-collapse: collapse;
        }
        #webhooksTable th, #webhooksTable td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        #webhooksTable th {
            background-color: #f5f7fa;
        }
        #eventLog {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #2c3e50;
            color: #ecf0f1;
            border-radius: 4px;
            font-family: monospace;
        }
        .event-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #34495e;
        }
        .timestamp {
            color: #95a5a6;
            font-size: 12px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }
        .badge-payment {
            background-color: #3498db;
            color: white;
        }
        .badge-invoice {
            background-color: #9b59b6;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Webhook Integrator Dashboard</h1>
    
    <div class="card">
        <h2>Webhook Management</h2>
        
        <div class="form-group">
            <label for="eventTypeSelect">Event Type:</label>
            <select id="eventTypeSelect">
                <option value="payment.received">payment.received</option>
                <option value="payment.processed">payment.processed</option>
                <option value="payment.failed">payment.failed</option>
                <option value="invoice.created">invoice.created</option>
                <option value="invoice.paid">invoice.paid</option>
                <option value="invoice.overdue">invoice.overdue</option>
            </select>
        </div>
        
        <div class="button-group">
            <button id="registerBtn">Register Webhook</button>
            <button id="unregisterBtn">Unregister Webhook</button>
        </div>
    </div>
    
    <div class="card">
        <h2>Testing Tools</h2>
        
        <div class="button-group">
            <button id="pingBtn">Test Ping</button>
            <button id="simulateBtn">Simulate Event</button>
            <button id="listWebhooksBtn">List Registered Webhooks</button>
        </div>
    </div>
    
    <div class="card">
        <h2>Registered Webhooks</h2>
        <div id="webhooksContainer">
            <table id="webhooksTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>URL</th>
                        <th>Event Type</th>
                        <th>Created At</th>
                    </tr>
                </thead>
                <tbody id="webhooksTableBody">
                    <tr>
                        <td colspan="4">No webhooks registered yet</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="card">
        <h2>Event Log</h2>
        <div id="eventLog">
            <div class="event-item">
                <span class="timestamp">[System] Welcome to the Webhook Integrator Dashboard</span>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h2>API Response</h2>
        <div id="responseContainer">No API response yet</div>
    </div>
    
    <script>
        // DOM Elements
        const eventTypeSelect = document.getElementById('eventTypeSelect');
        const registerBtn = document.getElementById('registerBtn');
        const unregisterBtn = document.getElementById('unregisterBtn');
        const pingBtn = document.getElementById('pingBtn');
        const simulateBtn = document.getElementById('simulateBtn');
        const listWebhooksBtn = document.getElementById('listWebhooksBtn');
        const responseContainer = document.getElementById('responseContainer');
        const webhooksTableBody = document.getElementById('webhooksTableBody');
        const eventLog = document.getElementById('eventLog');
        
        // Add event to the log
        function addToEventLog(message, eventType = null) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            
            let badgeHtml = '';
            if (eventType) {
                const badgeClass = eventType.startsWith('payment') ? 'badge-payment' : 'badge-invoice';
                badgeHtml = `<span class="badge ${badgeClass}">${eventType}</span>`;
            }
            
            eventItem.innerHTML = `
                <span class="timestamp">[${timestamp}]</span> ${badgeHtml}${message}
            `;
            
            eventLog.insertBefore(eventItem, eventLog.firstChild);
        }
        
        // Display API response
        function displayResponse(response, isError = false) {
            responseContainer.textContent = JSON.stringify(response, null, 2);
            responseContainer.className = isError ? 'error' : 'success';
        }
        
        // Update webhooks table
        function updateWebhooksTable(webhooks) {
            if (webhooks.length === 0) {
                webhooksTableBody.innerHTML = '<tr><td colspan="4">No webhooks registered yet</td></tr>';
                return;
            }
            
            webhooksTableBody.innerHTML = '';
            webhooks.forEach(webhook => {
                const row = document.createElement('tr');
                
                const idCell = document.createElement('td');
                idCell.textContent = webhook.id;
                
                const urlCell = document.createElement('td');
                urlCell.textContent = webhook.url;
                
                const eventTypeCell = document.createElement('td');
                eventTypeCell.textContent = webhook.event_type;
                
                const createdAtCell = document.createElement('td');
                createdAtCell.textContent = new Date(webhook.created_at).toLocaleString();
                
                row.appendChild(idCell);
                row.appendChild(urlCell);
                row.appendChild(eventTypeCell);
                row.appendChild(createdAtCell);
                
                webhooksTableBody.appendChild(row);
            });
        }
        
        // API Request Helper
        async function makeApiRequest(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(endpoint, options);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'API request failed');
                }
                
                displayResponse(data);
                return data;
            } catch (error) {
                displayResponse({ error: error.message }, true);
                throw error;
            }
        }
        
        // Register webhook event handler
        registerBtn.addEventListener('click', async () => {
            const eventType = eventTypeSelect.value;
            
            try {
                const data = await makeApiRequest('/api/register', 'POST', { event_type: eventType });
                addToEventLog(`Registered webhook for ${eventType}`, eventType);
                listWebhooksBtn.click(); // Refresh the webhooks list
            } catch (error) {
                addToEventLog(`Failed to register webhook: ${error.message}`);
            }
        });
        
        // Unregister webhook event handler
        unregisterBtn.addEventListener('click', async () => {
            const eventType = eventTypeSelect.value;
            
            try {
                const data = await makeApiRequest('/api/unregister', 'POST', { event_type: eventType });
                addToEventLog(`Unregistered webhook for ${eventType}`, eventType);
                listWebhooksBtn.click(); // Refresh the webhooks list
            } catch (error) {
                addToEventLog(`Failed to unregister webhook: ${error.message}`);
            }
        });
        
        // Ping test event handler
        pingBtn.addEventListener('click', async () => {
            try {
                const data = await makeApiRequest('/api/test-ping');
                addToEventLog(`Sent ping to ${data.data.ping_count} webhooks`);
            } catch (error) {
                addToEventLog(`Failed to send ping: ${error.message}`);
            }
        });
        
        // Simulate event handler
        simulateBtn.addEventListener('click', async () => {
            const eventType = eventTypeSelect.value;
            
            try {
                const data = await makeApiRequest('/api/simulate', 'POST', { event_type: eventType });
                addToEventLog(`Simulated ${eventType} event`, eventType);
            } catch (error) {
                addToEventLog(`Failed to simulate event: ${error.message}`);
            }
        });
        
        // List webhooks event handler
        listWebhooksBtn.addEventListener('click', async () => {
            try {
                const data = await makeApiRequest('/api/list-webhooks');
                updateWebhooksTable(data.webhooks);
                addToEventLog(`Retrieved ${data.webhooks.length} registered webhooks`);
            } catch (error) {
                addToEventLog(`Failed to list webhooks: ${error.message}`);
            }
        });
        
        // Initialize by listing webhooks
        listWebhooksBtn.click();
    </script>
</body>
</html>